<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="VIT-ChainVote Admin Dashboard">
    <title>üîê Shadow Dashboard | VIT-ChainVote</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
    <!-- Global Loading Overlay -->
    <div id="globalLoader" class="loading-overlay hidden">
        <div class="loader-vortex"></div>
        <div class="loading-text" id="loaderText">Processing...</div>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                üîê Shadow Dashboard
            </div>
            <div class="nav-links">
                <span class="status-badge" id="electionStatus"></span>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Control Panel -->
        <section class="section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Election Control</h2>
                    <div id="adminEmail" style="color: var(--text-secondary);"></div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-success" onclick="startElection()" id="startBtn">
                        ‚ñ∂Ô∏è Start Election
                    </button>
                    <button class="btn btn-danger" onclick="stopElection()" id="stopBtn">
                        ‚èπÔ∏è Stop Election
                    </button>
                    <button class="btn btn-outline" onclick="viewAudit()">
                        üìä View Audit
                    </button>
                    <button class="btn btn-danger" onclick="resetBlockchain()">
                        üîÑ Reset Ledger
                    </button>
                </div>

                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="totalVotes">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Votes</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #4facfe;" id="chainLength">1</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">Blocks Mined</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #22c55e;" id="chainValid">‚úì</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">Chain Integrity</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Candidate Registration -->
        <section class="section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>‚ûï Register Candidate</h2>
                </div>

                <form id="candidateForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Candidate Name</label>
                            <input type="text" class="form-input" id="candidateName" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="candidateDepartment" required>
                                <option value="">Select department</option>
                                <option value="CSE">CSE</option>
                                <option value="IT">IT</option>
                                <option value="ENTC">ENTC</option>
                                <option value="MECH">MECH</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="regBtn">
                        ü§ñ Generate Manifesto & Register
                    </button>
                </form>
            </div>
        </section>

        <!-- Registered Candidates -->
        <section class="section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>üë• Registered Candidates</h2>
                    <button class="btn btn-outline" onclick="loadCandidates()">üîÑ Refresh</button>
                </div>

                <div id="candidatesList" class="candidates-grid">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä AI Election Audit</h2>
            </div>
            <div id="auditContent" style="max-height: 500px; overflow-y: auto;">
                <div class="spinner"></div>
            </div>
            <button class="btn btn-outline" onclick="closeModal('auditModal')" style="margin-top: 1rem; width: 100%;">
                Close
            </button>
        </div>
    </div>

    <script src="js/config.js"></script>

    function hideLoader() {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.classList.add('hidden');
    }

    function setBtnLoading(btnId, isLoading) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    if (isLoading) {
    btn.classList.add('btn-loading');
    btn.disabled = true;
    } else {
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    }
    }

    document.getElementById('adminEmail').textContent = adminEmail;

    // Load initial data
    loadElectionState();
    loadCandidates();
    setInterval(loadElectionState, 3000);

    // Candidate Form
    document.getElementById('candidateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('candidateName').value.trim();
    const department = document.getElementById('candidateDepartment').value;
    const submitBtn = e.target.querySelector('button[type="submit"]');

    setBtnLoading(submitBtn.id || 'regBtn', true);
    showLoader('Gemini AI is generating a professional manifesto...');

    try {
    const response = await fetch(`${API_URL}/admin/candidate/add`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_email: adminEmail, name, department })
    });

    const data = await response.json();

    if (data.success) {
    confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#667eea', '#764ba2', '#4facfe']
    });
    alert('‚úÖ Candidate registered with AI-generated manifesto!');
    document.getElementById('candidateForm').reset();
    loadCandidates();
    } else {
    alert('‚ùå ' + data.message);
    }
    } catch (error) {
    alert('‚ùå Error: ' + error.message);
    } finally {
    setBtnLoading(submitBtn.id || 'regBtn', false);
    hideLoader();
    }
    });

    async function loadElectionState() {
    try {
    const response = await fetch(`${API_URL}/election/state`);
    const data = await response.json();

    if (data.success) {
    const statusBadge = document.getElementById('electionStatus');
    const state = data.state.toUpperCase();

    statusBadge.className = `status-badge status-${data.state}`;
    statusBadge.textContent = `${state === 'WAITING' ? '‚è∏Ô∏è' : state === 'LIVE' ? 'üî¥' : 'üîí'} ${state}`;

    document.getElementById('totalVotes').textContent = data.total_votes;
    document.getElementById('chainLength').textContent = data.chain_length;
    document.getElementById('chainValid').textContent = data.chain_valid ? '‚úì' : '‚úó';
    document.getElementById('chainValid').style.color = data.chain_valid ? '#22c55e' : '#ef4444';
    }
    } catch (error) {
    console.error('Error loading state:', error);
    }
    }

    async function loadCandidates() {
    try {
    const response = await fetch(`${API_URL}/admin/candidates?admin_email=${encodeURIComponent(adminEmail)}`);
    const data = await response.json();

    const container = document.getElementById('candidatesList');

    if (data.success && data.candidates.length > 0) {
    container.innerHTML = data.candidates.map(c => `
    <div class="candidate-card">
        <h3 class="candidate-name">${c.name}</h3>
        <span class="candidate-department">${c.department}</span>
        <p class="candidate-manifesto">"${c.manifesto}"</p>
        <button class="btn btn-danger" onclick="removeCandidate('${c.id}')" style="width: 100%;">
            üóëÔ∏è Remove
        </button>
    </div>
    `).join('');
    } else {
    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No candidates registered yet</p>
    ';
    }
    } catch (error) {
    console.error('Error loading candidates:', error);
    }
    }

    async function startElection() {
    if (!confirm('Start the election? Voters will be able to cast votes.')) return;

    try {
    const response = await fetch(`${API_URL}/admin/election/start`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_email: adminEmail })
    });

    const data = await response.json();
    alert(data.success ? '‚úÖ Election started!' : '‚ùå ' + data.message);
    loadElectionState();
    } catch (error) {
    alert('‚ùå Error: ' + error.message);
    }
    }

    async function stopElection() {
    if (!confirm('Stop the election and calculate results?')) return;

    try {
    const response = await fetch(`${API_URL}/admin/election/stop`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_email: adminEmail })
    });

    const data = await response.json();
    alert(data.success ? '‚úÖ Election stopped! Results calculated.' : '‚ùå ' + data.message);
    loadElectionState();
    } catch (error) {
    alert('‚ùå Error: ' + error.message);
    }
    }

    async function resetBlockchain() {
    if (!confirm('‚ö†Ô∏è WARNING: This will wipe the entire blockchain and all data. Continue?')) return;
    if (!confirm('This action cannot be undone. Are you absolutely sure?')) return;

    try {
    const response = await fetch(`${API_URL}/admin/election/reset`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_email: adminEmail })
    });

    const data = await response.json();
    alert(data.success ? '‚úÖ Blockchain reset to genesis' : '‚ùå ' + data.message);
    loadElectionState();
    loadCandidates();
    } catch (error) {
    alert('‚ùå Error: ' + error.message);
    }
    }

    async function removeCandidate(candidateId) {
    if (!confirm('Remove this candidate?')) return;

    try {
    const response = await fetch(`${API_URL}/admin/candidate/remove`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_email: adminEmail, candidate_id: candidateId })
    });

    const data = await response.json();
    alert(data.success ? '‚úÖ Candidate removed' : '‚ùå ' + data.message);
    loadCandidates();
    } catch (error) {
    alert('‚ùå Error: ' + error.message);
    }
    }

    async function viewAudit() {
    document.getElementById('auditModal').classList.remove('hidden');

    try {
    const response = await fetch(`${API_URL}/admin/audit?admin_email=${encodeURIComponent(adminEmail)}`);
    const data = await response.json();

    const content = document.getElementById('auditContent');

    if (data.success) {
    content.innerHTML = `
    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
        <h3 style="margin-bottom: 1rem;">ü§ñ AI Analysis</h3>
        <p style="white-space: pre-wrap; line-height: 1.8;">${data.audit}</p>
    </div>
    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius-md);">
        <h3 style="margin-bottom: 1rem;">üìä Results Breakdown</h3>
        ${Object.entries(data.results).map(([dept, result]) => `
        <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
            <h4>${dept}</h4>
            <p>Winner: ${result.winner?.name || 'No votes'}</p>
            <p>Votes: ${result.winner?.votes || 0} / ${result.total_votes}</p>
            <p>Margin: ${result.margin || 0}</p>
        </div>
        `).join('')}
    </div>
    `;
    } else {
    content.innerHTML = `<p style="color: var(--text-secondary);">${data.message}</p>`;
    }
    } catch (error) {
    document.getElementById('auditContent').innerHTML = `<p style="color: #ef4444;">Error loading audit</p>`;
    }
    }

    function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
    }

    function logout() {
    localStorage.removeItem('adminEmail');
    window.location.href = 'index.html';
    }
    </script>
</body>

</html>